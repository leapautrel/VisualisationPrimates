---
title: "Conservation des primates de la forÃªt atlantique d'AmÃ©rique du Sud"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
---

```{r library_packages, include=FALSE}
# Packages
library(flexdashboard)
library(ggplot2) ; theme_set(theme_minimal())
library(dplyr) ; options(dplyr.summarise.inform = FALSE)
library(grid) ; library(gridExtra) ; library(ggpubr)
library(plotly)
library(ggmap)
library(htmltools)
```


```{r import_data, include=FALSE}
occurrence <- read.csv("./dataset/ATLANTIC-PR_Occurrence.csv", header = TRUE, sep = ";")

# Suppression des espaces inutiles
occurrence$SPECIES <-
	as.factor(gsub("^\\s+|\\s+$", "", occurrence$SPECIES))

# SÃ©lection de colonnes
occ <- occurrence %>% select(SPECIES,
														 SP_ORIGIN,
														 ALTITUDE,
														 ANNUAL_TEMP,
														 ANNUAL_RAIN,
														 LONGITUDE_X,
														 LATITUDE_Y)
# Altitude : quanti -> classe
occ$ALTITUDE[occ$ALTITUDE < 200] = "Plaine"
occ$ALTITUDE[as.numeric(occ$ALTITUDE) < 1000] = "Basse Montagne"
occ$ALTITUDE[as.numeric(occ$ALTITUDE) >= 1000] = "Haute Montagne"
occ$ALTITUDE <- as.factor(occ$ALTITUDE)
occ <- occ[!is.na(occ$ALTITUDE), ]

# PluviomÃ©trie : quanti -> classe
occ$ANNUAL_RAIN[occ$ANNUAL_RAIN < 1100] = "Sec"
occ$ANNUAL_RAIN[as.numeric(occ$ANNUAL_RAIN) < 1700] = "Moyen"
occ$ANNUAL_RAIN[as.numeric(occ$ANNUAL_RAIN) >= 1700] = "Humide"
occ$ANNUAL_RAIN <- as.factor(occ$ANNUAL_RAIN)
occ <- occ[!is.na(occ$ANNUAL_RAIN), ]

# Suppression des lignes oÃ¹ espÃ¨ces pas correctes (croisement ou sp. indÃ©terminÃ©e)
occ <-
	occ[!(
		as.character(occ$SPECIES) %in% c(
			"Callithrix jacchus X Callithrix aurita",
			"Callithrix jacchus X Callithrix penicillata",
			"Callithrix kuhlii x Callithrix penicillata",
			"Callithrix sp.",
			"Sapajus sp.",
			"Callicebus sp.",
			"Alouatta sp."
		)
	),]
occ$SPECIES <- factor(occ$SPECIES)

# Ajout informations iucn
iucn <- read.csv("./dataset/iucn.csv")
i <- iucn %>% select(scientificName, redlistCategory)
occ <- left_join(occ, i, by = c("SPECIES" = "scientificName"))

# Changement ordre levels
occ$redlistCategory = factor(
	occ$redlistCategory,
	levels = c(
		"Critically Endangered",
		"Endangered",
		"Vulnerable",
		"Near Threatened",
		"Least Concern",
		"Data Deficient"
	)
)
```


```{r find_data, include=FALSE}
nb_especes_autochtones <- nrow(occ %>% 
	select(SPECIES, SP_ORIGIN) %>% 
	filter(SP_ORIGIN == "Autochtone") %>% 
	mutate(SPECIES = factor(SPECIES)) %>% 
	distinct(SPECIES, SP_ORIGIN))

especes_menacees <-  occ %>% 
	select(SPECIES, redlistCategory) %>% 
	filter(
		redlistCategory == "Critically Endangered" |
			redlistCategory == "Endangered"  |
			redlistCategory == "Vulnerable"
	) %>%
	mutate(SPECIES = factor(SPECIES)) %>% 
	distinct(SPECIES)
	
especes_CR <- occ %>% 
	select(SPECIES, redlistCategory) %>% 
	filter(redlistCategory == "Critically Endangered") %>% 
	mutate(SPECIES = factor(SPECIES)) %>% 
	distinct(SPECIES)

especes_endangered <- nrow(
	occ %>%
		select(SPECIES, redlistCategory) %>%
		filter(redlistCategory == "Endangered") %>%
		mutate(SPECIES = factor(SPECIES)) %>%
		distinct(SPECIES)
)

especes_vulnerable <- nrow(
	occ %>%
		select(SPECIES, redlistCategory) %>%
		filter(redlistCategory == "Vulnerable") %>%
		mutate(SPECIES = factor(SPECIES)) %>%
		distinct(SPECIES)
)

```



Types de zones Ã  protÃ©ger
=====================================  

Column
-------------------------------------

### Distribution des espÃ¨ces dans les diffÃ©rents types de milieux
```{r}
f_sep_donnees <- function(donnees, alti, pluvio) {
  
  # Sélection des données pour pluvio et alti
  dta_plot <- donnees %>%
    filter(ANNUAL_RAIN == pluvio & ALTITUDE == alti) %>%
    group_by(SPECIES, ALTITUDE, ANNUAL_RAIN, redlistCategory) %>%
    summarise(n = n())
  
  # Tri par ordre croissant
  dta_plot$SPECIES = factor(dta_plot$SPECIES,
                            levels = dta_plot$SPECIES[order(dta_plot$n, 
                                                            decreasing = TRUE)])
  
  # Nouvelle colonne avec seulement les levels dans ce sous jeu de données (redlistCategory a tous les levels)
  dta_plot$redlistCategory2 <- factor(dta_plot$redlistCategory)
  
  return(dta_plot)
}
# Fonction plot_palette_specifique pour récupérer la palette de couleur adaptée au nombre de levels ----
plot_palette_specifique <- function(dta_plot){
  
  # Définition de la palette de couleurs complète
  pal_iucn <- palette(c(
    "#B3343D", # "Critically Endangered",
    "#CF6B48", # "Endangered",
    "#E89E4A", # "Vulnerable",
    "#FFCF45", # "Near Threatened",
    "#438A32", # "Least Concern",
    "#C9C9C9"  # "Data Deficient",
  ))
  
  # Si 2 ou plus levels : on construit une palette.
  if (length(levels(dta_plot$redlistCategory2)) > 1) {
    # Initialisation
    new_pal_values = c()
    
    # Boucle pour récupérer les bons levels
    for (rl2 in 1:length(levels(dta_plot$redlistCategory2))) {
      for (rl1 in 1:length(levels(dta_plot$redlistCategory))) {
        if ((levels(dta_plot$redlistCategory2)[rl2]) == levels(dta_plot$redlistCategory)[rl1]) {
          new_pal_values = c(new_pal_values, pal_iucn[rl1])
        }
      }
    }
    
    # Transformation au format palette
    new_pal = palette(value = new_pal_values)
  }
  
  # Si 1 level seulement : on renvoie une couleur unique.
  else if (length(levels(dta_plot$redlistCategory2)) == 1) {
    for (rl1 in 1:length(levels(dta_plot$redlistCategory))) {
      if ((levels(dta_plot$redlistCategory2)[1]) == levels(dta_plot$redlistCategory)[rl1]) {
        new_pal = pal_iucn[rl1]
      }
    }
  }
  return(new_pal)
}
# Fonction plot_a_p pour obtenir un graphique pour chaque type de données ----
plot_a_p <- function(donnees, alti, pluvio, legende_bool = FALSE){
  
  # On récupère les données spécifiques pour alti et pluvio
  dta_plot <- f_sep_donnees(donnees, alti, pluvio)
  # On récupère la palette de couleurs
  new_pal_iucn <- plot_palette_specifique(dta_plot)
  
  # On ajoute des couleurs de fond selon la valeur de pluvio
  if (pluvio == "Sec"){background_color = "#E0D5C8"}
  else if (pluvio == "Moyen"){background_color = "#EAEBE4"}
  else if (pluvio == "Humide"){background_color = "#D9EBE8"}
  
  # On créé des variables de style pour layout
  axe_x_list <- list(
    title = "",
    zeroline = FALSE,
    showline = FALSE,
    showticklabels = FALSE,
    showgrid = FALSE
  )
  axe_y_list <- list(
    range = c(0, 600),
    title = "",
    zeroline = FALSE,
    showline = FALSE,
    showticklabels = FALSE,
    showgrid = FALSE
  )
  
  # On construit la figure
  l <- list(
  font = list(
    family = "sans-serif",
    size = 11,
    color = "#000"),
  bgcolor = "white")
  
  figure = plot_ly(
    dta_plot,
    type = 'bar',
    x =  ~ SPECIES,
    y =  ~ n,
    color =  ~ redlistCategory,
    legendgroup = ~ redlistCategory,
    showlegend = legende_bool,
    colors = new_pal_iucn
  ) %>%
    layout(xaxis = axe_x_list,
           yaxis = axe_y_list,
  paper_bgcolor = background_color,
  plot_bgcolor = background_color,
  legend = l)
  
  return(figure)
}
# On créé les plot ----
# Pluvio = Humide
plot_h_p <- plot_a_p(donnees = occ, pluvio = "Humide", alti = "Plaine")
plot_h_b <- plot_a_p(donnees = occ, pluvio = "Humide", alti = "Basse Montagne")
plot_h_h <- plot_a_p(donnees = occ, pluvio = "Humide", alti = "Haute Montagne")
# Pluvio = Moyen
plot_m_p <- plot_a_p(donnees = occ, pluvio = "Moyen", alti = "Plaine")
plot_m_b <- plot_a_p(donnees = occ, pluvio = "Moyen", alti = "Basse Montagne")
plot_m_h <- plot_a_p(donnees = occ, pluvio = "Moyen", alti = "Haute Montagne")
# Pluvio = Sec
plot_s_p <- plot_a_p(donnees = occ, pluvio = "Sec", alti = "Plaine")
plot_s_b <- plot_a_p(donnees = occ, pluvio = "Sec", alti = "Basse Montagne")
plot_s_h <- plot_a_p(donnees = occ, pluvio = "Sec", alti = "Haute Montagne", legende_bool = TRUE)
library(htmltools)
browsable(div(style = "display: flex; flex-wrap: wrap; justify-content: center;",
    div(plot_s_h, style = "width: 30%;height: 11em;display: flex"),
    div(plot_m_h, style = "width: 30%;height: 11em;display: flex"),
    div(plot_h_h, style = "width: 30%;height: 11em;display: flex"),
    div(plot_s_b, style = "width: 30%;height: 11em;display: flex"),
    div(plot_m_b, style = "width: 30%;height: 11em;display: flex"),
    div(plot_h_b, style = "width: 30%;height: 11em;display: flex"),
    div(plot_s_p, style = "width: 30%;height: 11em;display: flex"),
    div(plot_m_p, style = "width: 30%;height: 11em;display: flex"),
    div(plot_h_p, style = "width: 30%;height: 11em;display: flex")))
```
